{% extends 'base.html' %}
{% load static %}
{% load bootstrap %}

<!doctype html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'chart.css' %}">
    {% block title %} Charts panel {% endblock %}

</head>
<body>
{% block content %}
    <div class="chart-container" id="myCharts">
    </div>
    <h1>Devices</h1>
    {% if device_id %}
        <p>Device ID: {{ device_id }}</p>
    {% else %}
        <p>No device ID available.</p>
    {% endif %}


    <h1 id="temperatureValue">{{ text }}</h1>

    <p id="demo"></p>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        var chart = null;
        var number_charts = [];
        var maxColumns = 5;
        var sensors_counter = 1;
        var device_dict = {};
        var isFirstMessage = true;
        var message = {
            token: "{{ access_token }}"
        };
        console.log(JSON.stringify(message));

        var socket = new WebSocket('ws://localhost:8000/device/{{ device_id }}/sensor/data');
        socket.onopen = function () {
            socket.send(JSON.stringify(message));
        };

        socket.onmessage = function (e) {
            var wsData = JSON.parse(e.data);

            // Licznik ilości sensorów

            //Iteracja urządzenia
            // Iteracja po device_id
            if (isFirstMessage) { // Sprawdzanie, czy to jest pierwsza wiadomość
                isFirstMessage = false; // Ustawienie flagi na false po otrzymaniu pierwszej wiadomości

                // Licznik ilości sensorów
                for (var device_id in wsData) {
                    if (!device_dict.hasOwnProperty(device_id)) {
                        device_dict[device_id] = {};
                    }
                    for (var sensor_id in wsData[device_id]) {
                        if (!device_dict[device_id].hasOwnProperty(sensor_id)) {
                            device_dict[device_id][sensor_id] = {};
                            device_dict[device_id][sensor_id]['timestamp'] = [];
                            device_dict[device_id][sensor_id]['value'] = [];
                            sensors_counter++;
                        }
                        device_dict[device_id][sensor_id]['timestamp'].push(wsData[device_id][sensor_id]['timestamp']);
                        device_dict[device_id][sensor_id]['value'].push(wsData[device_id][sensor_id]['value']);
                        if (device_dict[device_id][sensor_id]['timestamp'].length > maxColumns) {
                            device_dict[device_id][sensor_id]['timestamp'].shift();
                        }
                        if (device_dict[device_id][sensor_id]['value'].length > maxColumns) {
                            device_dict[device_id][sensor_id]['value'].shift();
                        }
                    }
                }
                console.log("Suma ilości zmiennych sensor_id: " + (sensors_counter - 1));
                console.log(device_dict);

                for (var x = 1; x < sensors_counter; x++) {
                    const ctx2 = document.getElementById("myCharts")
                    var ctx = document.createElement('canvas');
                    ctx.id = x
                    ctx2.appendChild(ctx)
                    ctx_now = document.getElementById(x)
                    number_charts[x] = new Chart(ctx_now, {
                            type: 'line',
                            data: {
                                labels: [2],
                                datasets: [{
                                    label: 'Terrarium Temperature: ',
                                    data: [1],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                fill: true,
                                maintainAspectRatio: true,
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        min: 1,
                                        max: 40
                                    }
                                },
                                animation: {
                                    duration: 0
                                }
                            }
                        }
                    )
                }
                // Aktualizacja danych wykresu
                for (var j in device_dict) {
                    for (var y in device_dict[j]) {
                        number_charts[y].data.labels = device_dict[j][y]['timestamp'];
                        number_charts[y].data.datasets[0].data = device_dict[j][y]['value'];
                        number_charts[y].data.datasets[0].label = device_dict[j][y]['value'][0];
                        number_charts[y].options.animation.duration = 0;
                        number_charts[y].update();
                    }
                }
            } else {
                // Obsługa pozostałych wiadomości
                // Aktualizacja danych wykresu bez ponownego pobierania sumy sensorów
                for (var j in device_dict) {
                    for (var y in device_dict[j]) {
                        device_dict[j][y]['timestamp'].push(wsData[j][y]['timestamp']);
                        device_dict[j][y]['value'].push(wsData[j][y]['value']);
                        if (device_dict[j][y]['timestamp'].length > maxColumns) {
                            device_dict[j][y]['timestamp'].shift();
                        }
                        if (device_dict[j][y]['value'].length > maxColumns) {
                            device_dict[j][y]['value'].shift();
                        }

                        number_charts[y].data.labels = device_dict[j][y]['timestamp'];
                        number_charts[y].data.datasets[0].data = device_dict[j][y]['value'];
                        number_charts[y].options.animation.duration = 0;
                        number_charts[y].update();
                    }
                }
            }
        };

    </script>
    {% if access_token %}
        <p>Twój token: {{ access_token }}</p>
    {% else %}
        <p>Brak tokena.</p>
    {% endif %}
{% endblock %}
</body>
</html>


